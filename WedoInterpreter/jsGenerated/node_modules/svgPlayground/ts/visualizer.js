var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define(["require", "exports", "svgdotjs", "./utils"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var svgdotjs_1 = require("svgdotjs");
    var utils_1 = require("./utils");
    //.size(3148 / 5, 1764 / 5).
    var Visualizer = /** @class */ (function (_super) {
        __extends(Visualizer, _super);
        function Visualizer(svg) {
            var _this = _super.call(this) || this;
            _this.svg = svg;
            _this.nodeStartOnMap = undefined;
            _this.nodeFinishOnMap = undefined;
            _this.path = undefined;
            _this.line = undefined;
            _this.previousShape = undefined;
            _this.previousOpacity = 1;
            _this.startStateID = undefined;
            _this.finishStateID = undefined;
            _this.nodeStartInNaviText = undefined;
            _this.nodeFinishInNaviText = undefined;
            _this.nodeFinishNaviBar = undefined;
            _this.nodeStartNaviBar = undefined;
            _this.rho = undefined;
            return _this;
        }
        Visualizer.createVisualizer = function (path, htmlSelector, size) {
            var visualizerPromise = Visualizer.preload(path, htmlSelector)
                .then(function (svg) {
                Visualizer.scaleSVGtoSize(svg, size);
                var visualizer = new Visualizer(svg);
                visualizer.addEventListeners();
                return visualizer;
            });
            return visualizerPromise;
        };
        Visualizer.preload = function (path, htmlSelector) {
            var svgPromise = Visualizer.loadSVG(path)
                .then(function (text) {
                return Visualizer.addSVGToHTML(text, htmlSelector);
            });
            return svgPromise;
        };
        Visualizer.loadSVG = function (filePath) {
            return utils_1.Utils.file_get_contents(filePath);
        };
        Visualizer.addSVGToHTML = function (text, htmlSelector) {
            document.querySelector(htmlSelector).innerHTML = "";
            var svg = svgdotjs_1.SVG().addTo(htmlSelector);
            svg.svg(text);
            svg.viewbox(svg.findOne('svg').attr("viewBox"));
            return svg;
        };
        Visualizer.prototype.getActions = function () {
            var listOfPaths = new Array();
            var allPaths = this.svg.find('g[id^="path-"]');
            allPaths.each(function (item) {
                var idName = item.attr("id");
                var tokens = idName.split("-");
                listOfPaths.push({
                    startState: {
                        id: parseInt(tokens[1])
                    },
                    finishState: {
                        id: parseInt(tokens[2])
                    }
                });
            });
            return listOfPaths;
        };
        Visualizer.scaleSVGtoSize = function (svg, size) {
            var svgWidthHeight = {
                width: svg.viewbox().width,
                height: svg.viewbox().height
            };
            var newSize = Visualizer.fitInNewSize(svgWidthHeight, size);
            svg.size(newSize.width, newSize.height);
        };
        Visualizer.fitInNewSize = function (originSize, newSize) {
            var factorWidth = newSize.width / originSize.width;
            var factorHeight = newSize.height / originSize.height;
            var factor = Math.min(factorWidth, factorHeight);
            return {
                width: originSize.width * factor,
                height: originSize.height * factor
            };
        };
        Visualizer.prototype.processNotAllowedActions = function (notAllowedActions) {
            for (var _i = 0, notAllowedActions_1 = notAllowedActions; _i < notAllowedActions_1.length; _i++) {
                var notAllowedAction = notAllowedActions_1[_i];
                var notAllowedPath = this.svg.findOne("#path-" + notAllowedAction.startState.id + "-" + notAllowedAction.finishState.id + " path");
                notAllowedPath.attr({
                    stroke: 'red',
                    'stroke-linecap': 'round',
                    'stroke-linejoin': 'round',
                    'stroke-width': 7,
                    'stroke-dasharray': '12 24'
                });
                this.setMarker(notAllowedPath);
                //document.querySelector(notAllowedPath).innerHTML = ""
            }
        };
        Visualizer.prototype.setMarker = function (notAllowedPath) {
            try {
                notAllowedPath.marker('start', 5, 5, function (add) {
                    add.circle(5).fill('#ff0000');
                });
                notAllowedPath.marker('end', 5, 5, function (add) {
                    add.circle(5).fill('#ff0000');
                });
            }
            catch (error) {
                if (error instanceof TypeError) {
                    console.log("Unsupported type for the marker: " + error.message + ". Expected type: line, polyline or path. ");
                }
            }
        };
        //set inital values on map and in the navi
        Visualizer.prototype.setInitialValuesOnMap = function (startStateID, finishStateID, totalTime, totalQLearningSteps) {
            this.startStateID = startStateID;
            this.finishStateID = finishStateID;
            this.setStartAndFinishState(this.startStateID, this.finishStateID);
            this.setTotalNumberOfEpisodes(totalQLearningSteps);
            this.setTotalTime(totalTime);
            var setInitialEpisode = this.svg.findOne('#episode > text:nth-child(3)');
            setInitialEpisode.plain('');
            this.nodeStartNaviBar = this.svg.findOne('#node-start-navi text');
            this.nodeStartNaviBar.plain('');
            this.rho = this.svg.findOne('#explore_exploit text');
            this.rho.plain('');
            this.nodeFinishNaviBar = this.svg.findOne('#node-finish-navi text');
            this.nodeFinishNaviBar.plain('');
            // this.startState.id, this.finishState.id, this.totalTime,this.qLearningSteps.length
        };
        Visualizer.prototype.setStartAndFinishState = function (startStateID, finishStateID) {
            this.nodeStartInNaviText = this.svg.findOne('#node-start  text');
            this.nodeStartInNaviText.plain('' + startStateID);
            this.nodeStartInNaviColour = this.svg.findOne('#node-start path');
            this.nodeFinishInNaviText = this.svg.findOne('#node-finish text');
            this.nodeFinishInNaviText.plain('' + finishStateID);
            this.nodeFinishInNaviColour = this.svg.findOne('#node-finish path');
        };
        Visualizer.prototype.setTotalTime = function (totalTime) {
            var formattedTime = utils_1.Utils.convertNumberToSeconds(totalTime);
            var timeCurrent = this.svg.findOne('#time > text:nth-child(1)');
            timeCurrent.plain('' + formattedTime);
        };
        Visualizer.prototype.setTotalNumberOfEpisodes = function (totalQLearningSteps) {
            var episodeTotal = this.svg.findOne('#episode > text:nth-child(2)');
            episodeTotal.plain('' + totalQLearningSteps);
        };
        Visualizer.prototype.onQLearningStep = function (newQLearnerStepDataAndPath, currentTime, executionDuration) {
            var _this = this;
            var newQLearnerStep = newQLearnerStepDataAndPath.qLearnerStepData;
            console.log("gotStep! " + newQLearnerStep.stepNumber);
            console.log("first measure " + Date.now());
            Visualizer.delay(0)
                .then(function () { return _this.showCurrentTime(currentTime); })
                .then(function () { return Visualizer.delay(0); })
                .then(function () { return _this.showCurrentEpisode(newQLearnerStep); })
                .then(function () { return Visualizer.delay(0.1 * executionDuration); })
                .then(function () { return _this.showCurrentStartNode(newQLearnerStep.state, newQLearnerStep.newState); })
                .then(function () { return Visualizer.delay(0); })
                .then(function () { return _this.showCurrentRho(newQLearnerStep.rho); })
                .then(function () { return Visualizer.delay(0.1 * executionDuration); })
                .then(function () { return _this.showCurrentStroke(0.6 * executionDuration, 0.6 * executionDuration, newQLearnerStep.state, newQLearnerStep.newState, newQLearnerStep.qValueNew, 100); })
                .then(function () { return Visualizer.delay(0); })
                .then(function () { return _this.showCurrentFinishNode(newQLearnerStep.state, newQLearnerStep.newState); })
                .then(function () { return Visualizer.delay(0.6 * executionDuration); })
                .then(function () { return _this.showCurrentOptimalPath(newQLearnerStepDataAndPath.optimalPath); })
                .then(function () { return Visualizer.delay(0); })
                .then(function () { return _this.resetAllValues(newQLearnerStep.state, newQLearnerStep.newState); });
        };
        Visualizer.delay = function (ms) {
            return new Promise(function (resolve) { return setTimeout(resolve, ms); });
        };
        Visualizer.prototype.showCurrentTime = function (currentTime) {
            console.log("The new q Learnig step " + Date.now());
            var timeCurrent = this.svg.findOne('#time > text:nth-child(1)');
            timeCurrent.plain('' + utils_1.Utils.convertNumberToSeconds(currentTime));
        };
        Visualizer.prototype.showCurrentEpisode = function (newQLearnerStep) {
            console.log("Dalay ist zu Ende " + Date.now());
            var episodeCurrent = this.svg.findOne('#episode > text:nth-child(3)');
            episodeCurrent.plain('' + newQLearnerStep.stepNumber);
        };
        Visualizer.prototype.showCurrentStartNode = function (state, newState) {
            this.nodeStartNaviBar.plain('' + state);
            if (state == this.startStateID || newState == this.startStateID) {
                this.nodeStartInNaviColour.addClass("node-active");
            }
            this.nodeStartOnMap = this.svg.findOne('#node-' + state + ' path');
            this.nodeStartOnMap.addClass("node-active");
        };
        Visualizer.prototype.showCurrentRho = function (currentRho) {
            this.rho.plain('' + currentRho);
        };
        Visualizer.prototype.showCurrentStroke = function (duration, timeout, state, newState, qValue, maxQValue) {
            var shapeGroupId = '#path-' + state + '-' + newState;
            var shapes = this.svg.find(shapeGroupId + ' > path' + "," + shapeGroupId + " line");
            if (shapes.length != 1) {
                console.warn("shape not found or ambiguous");
                return;
            }
            var shape = shapes[0];
            var shapeLength = utils_1.Utils.calcShapeLength(shape);
            var shapeClone = shape.clone();
            shapeClone.stroke({ opacity: 1 });
            shapeClone.addTo(this.svg);
            shapeClone.addClass("shape-active");
            shapeClone.stroke({
                dasharray: 5 + ", " + 35,
                dashoffset: shapeLength,
                linecap: "round",
            });
            shapeClone.animate(duration, '>').attr("stroke-dashoffset", "0");
            setTimeout(function () {
                shapeClone.remove();
                shape.stroke({ opacity: -(1 / maxQValue) * qValue + 1 });
            }, timeout);
        };
        Visualizer.prototype.showCurrentFinishNode = function (state, newState) {
            if (state == this.finishStateID || newState == this.finishStateID) {
                this.nodeFinishInNaviColour.addClass("node-active");
            }
            this.nodeFinishOnMap = this.svg.findOne('#node-' + newState + ' path');
            this.nodeFinishOnMap.addClass("node-active");
            this.nodeFinishNaviBar.plain('' + newState);
        };
        Visualizer.prototype.showCurrentOptimalPath = function (optimalPath) {
            var currentOptimalPath = this.svg.findOne('#navi-optimal-path > text:nth-child(2)');
            var result = optimalPath != undefined ? optimalPath.join(' - ') : 'noch nicht gefunden';
            currentOptimalPath.plain(result);
        };
        Visualizer.prototype.resetAllValues = function (state, newState) {
            if (this.nodeStartOnMap) {
                this.nodeStartOnMap.removeClass("node-active").addClass("node-visited");
            }
            if (this.nodeFinishOnMap) {
                this.nodeFinishOnMap.removeClass("node-active").addClass("node-visited");
            }
            if (this.line) {
                this.line.removeClass("line-active");
            }
            if (this.path) {
                this.path.removeClass("path-active");
            }
            if (state == this.startStateID || newState == this.startStateID) {
                this.nodeStartInNaviColour.removeClass("node-active").addClass("node-visited");
            }
            if (state == this.finishStateID || newState == this.finishStateID) {
                this.nodeFinishInNaviColour.removeClass("node-active").addClass("node-visited");
            }
            this.nodeStartNaviBar.plain('');
            this.rho.plain('');
            this.nodeFinishNaviBar.plain('');
        };
        Visualizer.prototype.addEventListeners = function () {
            var buttonStepInto = this.svg.findOne("#navi-step-for-step-button");
            var buttonSpeed1x = this.svg.findOne('#navi-speed-normal');
            var buttonSpeed2x = this.svg.findOne('#navi-speed-2x');
            var buttonSpeed3x = this.svg.findOne('#navi-speed-3x');
            var buttonPause = this.svg.findOne("#navi-pause");
            var buttonStop = this.svg.findOne("#navi-stop");
            var that = this;
            buttonStepInto.click(function (e) {
                that.startPlayerForOneTick(0.1);
            });
            buttonStepInto.addClass("navi-button");
            buttonSpeed1x.click(function (e) {
                that.startPlayer(0.5);
            });
            buttonSpeed1x.addClass("navi-button");
            buttonSpeed2x.click(function (e) {
                that.startPlayer(100);
            });
            buttonSpeed2x.addClass("navi-button");
            buttonSpeed3x.click(function (e) {
                that.startPlayer(1000);
            });
            buttonSpeed3x.addClass("navi-button");
            buttonStop.click(function (e) {
                that.stopPlayer();
            });
            buttonStop.addClass("navi-button");
            buttonPause.click(function (e) {
                that.pausePlayer();
            });
            buttonPause.addClass("navi-button");
        };
        Visualizer.prototype.startPlayer = function (speed) {
            console.log("playerStarted!");
            this.dispatchEvent(new CustomEvent("playerStarted", {
                detail: speed
            }));
        };
        Visualizer.prototype.stopPlayer = function () {
            this.dispatchEvent(new CustomEvent("playerStopped"));
        };
        Visualizer.prototype.pausePlayer = function () {
            this.dispatchEvent(new CustomEvent("playerPaused"));
        };
        Visualizer.prototype.startPlayerForOneTick = function (speed) {
            this.dispatchEvent(new CustomEvent("playerStartedForOneStep", {
                detail: speed
            }));
        };
        Visualizer.prototype.drawPath = function (actions) {
            var _a;
            var combinedPath = undefined;
            for (var actionIndex in actions) {
                var firstAction = actions[parseInt(actionIndex)];
                var secondAction = actions[parseInt(actionIndex) + 1];
                var actionPath = Visualizer.findPathWithID(this.svg, firstAction, secondAction);
                if (secondAction !== undefined) {
                    try {
                        if (combinedPath == undefined) {
                            combinedPath = actionPath;
                        }
                        else {
                            var currentPathArray = actionPath.array(); //get array of path pieces
                            var currentPathArrayWithoutMovetto = currentPathArray.splice(0, 1); // cut off the first piece of path (Movetto) to seemless combination of passes
                            (_a = combinedPath.array()).push.apply(_a, currentPathArray);
                            combinedPath.plot(combinedPath.array());
                        }
                    }
                    catch (error) {
                        console.log(combinedPath);
                    }
                }
            }
            combinedPath.addTo(this.svg);
            combinedPath.addClass('line-follower-outside');
            // combinedPath.stroke({width: 80, color: '#ffffff', opacity: 1, linecap: 'round', linejoin: 'round'})
            //     .fill('none');
            var combinedPathCopy = combinedPath.clone();
            combinedPathCopy.addTo(this.svg);
            combinedPathCopy.addClass('line-follower-inside');
            // combinedPathCopy.stroke({width: 30, color: '#000000'})
            //     .fill('none');
            console.log(combinedPath.array());
        };
        /**
         *
         * @param svg
         * @param firstValue
         * @param secondValue
         * @return foundPath in {@link svg} or null if not found
         */
        Visualizer.findPathWithID = function (svg, firstValue, secondValue) {
            var linkIDPrefix = "path-";
            var foundPath = svg.findOne('#' + linkIDPrefix + firstValue + "-" + secondValue + " path ");
            return foundPath;
        };
        return Visualizer;
    }(EventTarget));
    exports.Visualizer = Visualizer;
});
